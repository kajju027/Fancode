<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>OFFICIAL FANCODE LIVE STREAM PLAYER | WATCH FREE HD CRICKET, FOOTBALL & SPORTS ONLINE | 24/7 HLS STREAMING</title>

<meta name="description" content="WATCH ALL FANCODE LIVE STREAMS, INCLUDING HD CRICKET, FOOTBALL, AND KABADDI, ON OUR CUSTOM HLS PLAYER. FREE, SMOOTH, AND SECURE LIVE SPORTS STREAMING.">

<meta name="referrer" content="no-referrer" />

<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amaranth:ital,wght@0,400;0,700;1,700&family=Bebas+Neue&family=Poppins:wght@400;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
    --bg-color: #121212;
    --primary-color: #e30000; /* Red Accent */
    --primary-color-dark: #b30000;
    --card-bg: #1e1e1e;
    --text-light: #f1f5f9;
    --text-muted: #94a3b8;
    --border-color: #2d2d2d;
    --popup-bg: #000000;
    --popup-shadow-color: rgba(227, 0, 0, 0.4);
    --plyr-color-main: #0ea5e9; /* Blue for Plyr progress bar */
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html,body{height:100%}
body {
    font-family: 'Amaranth', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-light);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 1rem;
    transition: background-color 0.3s ease;
}
.container {
    width: 100%;
    max-width: 800px;
    opacity: 0;
    transform: translateY(20px);
    animation: fadeIn 0.5s ease-out forwards;
}
@keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

.content-hidden .container {
    opacity: 0 !important;
    pointer-events: none;
}

.stream-header {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    padding: 0.75rem 1.25rem;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}
.stream-header h1 { font-size: 1.25rem; font-weight: 600; }
.live-badge {
    background-color: var(--primary-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(227, 0, 0, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(227, 0, 0, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(227, 0, 0, 0); }
}
#player-container {
    width: 100%;
    /* Fixed height for initial embed view */
    height: 50vh; 
    max-height: 600px;
    background-color: #000;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}

/* PLYR ELEMENT STYLES */
#player-container .plyr {
    width: 100%;
    height: 100%;
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
}

.plyr--fullscreen-active #player-container {
    border-radius: 0;
}

/* Fallback Rotation CSS */
.rotate-fallback-notice{
    position:absolute;
    left:12px;
    bottom:12px;
    z-index:22000;
    background:rgba(0,0,0,0.55);
    color:var(--text-light);
    padding:.4rem .6rem;
    border-radius:8px;
    font-size:.8rem;
    display:none;
}
.player-rotated{
    transform-origin: center center;
    width:100vh;
    height:100vw;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%) rotate(90deg);
    z-index:21000;
    border-radius:0;
}
.player-rotated .stream-header,
.player-rotated .info-card,
.player-rotated .back-link,
.plyr--fullscreen-active .stream-header,
.plyr--fullscreen-active .info-card,
.plyr--fullscreen-active .back-link {
    display: none !important;
}


.info-card {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem;
    margin-top: 1rem;
    text-align: center;
}
.info-card h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.25rem;
    font-weight: 400;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    color: var(--text-muted);
}
.action-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    background: linear-gradient(90deg, var(--primary-color), var(--primary-color-dark));
    color: white;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px var(--popup-shadow-color);
}
.action-button.copied { background: linear-gradient(90deg, #22c55e, #4ade80); }
.back-link {
    display: inline-block;
    width: 100%;
    text-align: center;
    margin-top: 1.5rem;
    color: var(--text-muted);
    text-decoration: none;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}
.back-link:hover { background-color: var(--card-bg); color: var(--text-light); }

/* ========================================
   NEW ERROR PAGE STYLES (Integrated)
   ========================================
*/
.error-container {
    width: 100%;
    /* Fits within the parent container */
    min-height: 60vh; 
    text-align: center;
    background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
    border: 1px solid #2d2d2d;
    border-radius: 24px;
    padding: 4rem 2rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 25px 60px rgba(0,0,0,0.9);
    font-family: 'Poppins', sans-serif; /* Explicitly use Poppins for error card */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.error-container::before {
    content: '';
    position: absolute;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
    pointer-events: none;
}

.error-icon-wrapper {
    position: relative;
    margin-bottom: 2.5rem;
}

.error-icon {
    font-size: 5rem;
    color: #ffffff;
    animation: float 3s ease-in-out infinite;
}

.error-ring {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 140px;
    height: 140px;
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 50%;
    animation: ripple 2.5s linear infinite;
}

.error-title {
    font-size: 2.5rem;
    font-weight: 700;
    text-transform: uppercase;
    color: #ffffff;
    letter-spacing: 6px;
    margin-bottom: 1.2rem;
    text-shadow: 0 0 15px rgba(255,255,255,0.2);
}

.error-desc {
    color: #94a3b8;
    font-size: 1.05rem;
    max-width: 450px;
    margin: 0 auto 3rem;
    line-height: 1.6;
}

.btn-premium-bw {
    background: #ffffff;
    color: #000000;
    padding: 16px 45px;
    border-radius: 50px;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 1.5px;
    text-decoration: none;
    border: 2px solid #ffffff;
    display: inline-flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(255,255,255,0.15);
    z-index: 10;
}

.btn-premium-bw:hover {
    background: transparent;
    color: #ffffff;
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(255,255,255,0.25);
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
}

@keyframes ripple {
    0% { width: 0; height: 0; opacity: 0.6; }
    100% { width: 220px; height: 220px; opacity: 0; }
}

@media (max-width: 480px) {
    .error-title { font-size: 1.8rem; letter-spacing: 3px; }
    .error-icon { font-size: 4rem; }
    .error-desc { font-size: 0.9rem; }
}

/* View Counter Styling (Exactly as provided) */
.view-counter {
    position: absolute;
    top: 10px;
    right: 12px;
    background: rgba(0, 0, 0, 0.55);
    padding: 5px 9px;
    border-radius: 6px;
    font-size: 11px;
    line-height: 1.3;
    color: #fff;
    font-weight: 600;
    text-align: right;
    z-index: 9999;
    pointer-events: none;
    font-family: 'Amaranth', sans-serif;
}
.view-counter .name {
    font-size: 10px;
    opacity: 0.85;
}
.view-counter .views {
    font-size: 12px;
    font-weight: 700;
}

/* --- Loading Overlay (Custom large and professional style) --- */
.loading-overlay {
    position: fixed;
    inset: 0;
    background: var(--popup-bg); /* Use pure black for full dark background */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 1;
    transition: opacity 0.5s ease;
    color: #fff;
}

.loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
}

/* Modern Gradient Loader (Large - 120px) */
.modern-loader {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    padding: 3px;
    background: conic-gradient(#0000 10%, var(--plyr-color-main));
    -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 12px), #000 0);
    animation: rotate 1.5s infinite linear;
    position: relative;
    margin-bottom: 30px;
}
.modern-loader::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: conic-gradient(from 180deg at 50% 50%, rgba(255, 255, 255, 0.2) 0deg, rgba(255, 255, 255, 0.8) 20deg, rgba(255, 255, 255, 0.2) 360deg);
}
@keyframes rotate {
    to { transform: rotate(1turn); }
}

.loading-overlay p {
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--plyr-color-main);
    text-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
}

/* Popup Styles (Exactly as provided) */
.popup-backdrop{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,1);
    z-index:11000;
    display:none;
    opacity:0;
    transition:opacity .28s ease;
}
.popup-backdrop.show{
    display:block;
    opacity:1;
}

.telegram-popup {
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%) scale(.96);
    background:var(--popup-bg);
    color:var(--text-light);
    padding:40px 25px;
    border-radius:16px;
    border:2px solid var(--primary-color);
    box-shadow:0 0 50px 10px rgba(227, 0, 0, 0.5), 0 0 20px rgba(227, 0, 0, 0.3) inset;
    z-index:12000;
    text-align:center;
    width: 90%;
    max-width: 400px;
    display: none;
    opacity:0;
    transition:all .28s cubic-bezier(.2,.9,.2,1);
}
.telegram-popup.show{ display:block; opacity:1; transform:translate(-50%,-50%) scale(1); }
.telegram-popup h2 {
    margin-top: 0;
    color: var(--primary-color);
    font-size: 1.75rem;
    font-weight: 700;
    text-shadow: 0 0 10px rgba(227, 0, 0, 0.5);
    margin-bottom: 0.75rem;
}
.telegram-popup p {
    font-size: 1rem;
    color: var(--text-muted);
    margin-bottom: 1.75rem;
    line-height: 1.5;
}
.telegram-popup button {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    font-size: 1rem;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.2s ease, box-shadow 0.3s ease;
}
.telegram-popup button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
}
.telegram-popup .join-btn {
    background: linear-gradient(90deg, var(--primary-color), var(--primary-color-dark));
    color: white;
    box-shadow: 0 0 12px rgba(227, 0, 0, 0.4);
}
.telegram-popup .join-btn:hover {
    box-shadow: 0 0 25px rgba(227, 0, 0, 0.7);
}
.telegram-popup .joined-btn {
    background-color: var(--border-color);
    color: var(--text-light);
    border: 1px solid var(--primary-color-dark);
}

@media (max-width: 480px) {
    .telegram-popup { padding: 30px 20px; max-width: 90%; }
    .telegram-popup h2 { font-size: 1.5rem; }
    .telegram-popup p { font-size: 0.9rem; }
}
</style>
</head>
<body>

<div class="loading-overlay" id="loading-overlay">
    <div class="modern-loader"></div>
    <p>Loading Stream... Preparing HD Quality.</p>
</div>

<div class="popup-backdrop" id="popupBackdrop"></div>

<main class="container">
    <div id="stream-content">
        </div>
</main>

<div class="telegram-popup" id="telegramPopup" role="dialog" aria-modal="true" aria-hidden="true">
    <h2><i class="fa-brands fa-whatsapp"></i> Support Us!</h2>
    <p>Join our Whatsapp channel <strong>FANCODE LIVE STREAM</strong> For Instant Updates And Exclusive Links.</p>
    <a href="https://whatsapp.com/channel/0029VaeylYYBPzjVNomWuZ0T" target="_blank" rel="noopener" id="joinLink"><button class="join-btn">Join Now</button></a>
    <button class="joined-btn" id="alreadyJoinedBtn">Already Joined</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script>
    const PLAYER_ID = 'player';
    
    // --- Configuration Constants ---
    const MATCH_DATA_URL = 'https://raw.githubusercontent.com/drmlive/fancode-live-events/refs/heads/main/fancode.json';
    const MATCH_ID_PARAM = 'id';
    const CDN_KEY_PARAM = 'cdn';
    
    const AUTO_QUALITY = 0;
    
    // --- View Counter Constants ---
    const STATIC_VIEW_KEY = 'Fancode Official'; 
    const HIT_BASE = 'https://sayan-prime.pages.dev/api/hit?key=';
    const GET_BASE = 'https://sayan-prime.pages.dev/api/get?key=';
    
    // --- DOM Elements ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const popupBackdrop = document.getElementById('popupBackdrop');
    const telegramPopup = document.getElementById('telegramPopup');
    const joinLink = document.getElementById('joinLink');
    const alreadyJoinedBtn = document.getElementById('alreadyJoinedBtn');
    const body = document.body;
    
    let plyrInstance = null;
    let hlsInstance = null;
    let playerInitialized = false;

    // --- Utility Functions ---
    function safeHTML(str){ const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
    
    function formatViews(num) {
        if (!num || isNaN(num)) return "0";
        if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
        if (num >= 1000) return (num / 1000).toFixed(1) + "K";
        return num;
    }

    function hidePopup(){
        telegramPopup.classList.remove('show');
        telegramPopup.setAttribute('aria-hidden','true');
        popupBackdrop.classList.remove('show');
        body.classList.remove('content-hidden');
    }

    function showPopup(){
        telegramPopup.classList.add('show');
        telegramPopup.setAttribute('aria-hidden','false');
        popupBackdrop.classList.add('show');
        body.classList.add('content-hidden');
    }
    
    // --- UPDATED ERROR DISPLAY FUNCTION ---
    function displayError(message) {
        loadingOverlay.classList.add('hidden');
        hidePopup();
        document.querySelector('.container').style.opacity = '1';

        const contentDiv = document.getElementById('stream-content');
        
        // Injecting the new stylish Error Page
        contentDiv.innerHTML = `
        <div class="error-container">
            <div class="error-icon-wrapper">
                <div class="error-ring"></div>
                <i class="fa-solid fa-tower-broadcast error-icon"></i>
            </div>

            <h1 class="error-title">Signal Lost</h1>

            <p class="error-desc">
                ${message} <br><br>
                The ID Might Be Expired &  The Broadcast Has Ended.
            </p>

            <a href="#" class="btn-premium-bw">
                <i class="fa-solid fa-list-ul"></i>
                New Broadcast List
            </a>
        </div>`;
        
        if (plyrInstance) plyrInstance.destroy();
    }
    
    // --- Counter Logic ---
    async function startViewCounter() { 
        const STREAM_KEY = STATIC_VIEW_KEY; 
        const HIT_URL = HIT_BASE + STREAM_KEY;
        const GET_URL = GET_BASE + STREAM_KEY;

        try {
            await fetch(HIT_URL + "&_=" + Date.now());
        } catch(e) {}

        async function updateViews() {
            try {
                const res = await fetch(GET_URL + "&_=" + Date.now());
                const json = await res.json();
                const views = json.total || 0;
                const viewCountElement = document.getElementById("viewCount");
                const viewChannelName = document.getElementById("viewChannelName");
                
                if (viewCountElement) {
                     viewCountElement.innerText = formatViews(Number(views)) + " Views";
                }
                if (viewChannelName) {
                    viewChannelName.innerText = STATIC_VIEW_KEY; 
                }

            } catch(err) {
                 if (document.getElementById("viewCount")) {
                    document.getElementById("viewCount").innerText = "0 Views";
                 }
            }
        }

        updateViews();
        setInterval(updateViews, 2000);
    }
    
    // --- Data Fetching Logic ---
    function getMatchParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const matchId = urlParams.get(MATCH_ID_PARAM);
        const cdnKey = urlParams.get(CDN_KEY_PARAM);
        return { matchId, cdnKey };
    }

    async function fetchMatchData(matchId, cdnKey) {
        if (!matchId) throw new Error("Missing Match ID in URL.");

        try {
            const res = await fetch(MATCH_DATA_URL, { cache: "no-store" });
            if (!res.ok) throw new Error('Data load failed');
            const data = await res.json();
            
            const match = (data.matches || []).find(m => m.match_id === Number(matchId));
            
            if (!match) throw new Error(`Match with ID ${matchId} not found.`);
            
            let streamUrl = null;
            let matchName = match.match_name || match.title || "LIVE STREAM";

            if (cdnKey === 'adfree') {
                streamUrl = match.adfree_url;
            } else {
                streamUrl = match.dai_url || match.m3u8 || match.src;
            }

            if (!streamUrl) throw new Error(`No stream URL found for the selected CDN.`);
            
            return { streamUrl, matchName, matchId };

        } catch(e) {
            throw e;
        }
    }

    // --- Player Logic (Orientation Lock) ---
    async function lockLandscape() {
        try {
          if ('orientation' in screen && screen.orientation && screen.orientation.lock) {
            await screen.orientation.lock("landscape");
            return { locked: true, method: 'screen.orientation.lock' };
          } else if (window.screen && window.screen.lockOrientation) {
            let ok = window.screen.lockOrientation('landscape');
            return { locked: !!ok, method: 'screen.lockOrientation' };
          } else {
            return { locked: false, reason: 'no-api' };
          }
        } catch (e) {
          console.warn("Orientation lock failed:", e);
          return { locked: false, error: e };
        }
    }
    function removeRotateCssFallback(){
        const pc = document.getElementById('player-container');
        if(!pc) return;
        pc.classList.remove('player-rotated');
        const notice = document.querySelector('.rotate-fallback-notice');
        if(notice) notice.style.display = 'none';
    }
    function applyRotateCssFallback(){
        const pc = document.getElementById('player-container');
        if(!pc) return;
        pc.classList.add('player-rotated');
        const notice = document.querySelector('.rotate-fallback-notice');
        if(notice) notice.style.display = 'block';
    }
    async function onFullScreenChange() {
        const fsElement = document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
        
        if (fsElement) {
            const lockRes = await lockLandscape();
            if (!lockRes.locked) {
                applyRotateCssFallback();
            }
        } else {
            setTimeout(async () => {
                await screen.orientation.unlock();
                removeRotateCssFallback();
            }, 100); 
        }
    }

    document.addEventListener('fullscreenchange', onFullScreenChange);
    document.addEventListener('webkitfullscreenchange', onFullScreenChange);
    document.addEventListener('msfullscreenchange', onFullScreenChange);
    
    window.addEventListener("orientationchange", () => {
        if (!document.fullscreenElement) {
          screen.orientation.unlock();
          removeRotateCssFallback();
        }
    });

    // Plyr Event Handlers
    function attachPlyrEvents() {
        if (!plyrInstance) return;

        plyrInstance.on('playing', () => loadingOverlay.classList.add('hidden'));
        plyrInstance.on('waiting', () => loadingOverlay.classList.remove('hidden'));
        plyrInstance.on('canplay', () => loadingOverlay.classList.add('hidden'));
    }

    // --- UI Rendering ---
    function renderPlayerUI(data) {
        const contentDiv = document.getElementById('stream-content');
        
        // Render the main structure using the data
        contentDiv.innerHTML = `
            <div class="stream-header">
                <h1>${safeHTML(data.matchName).toUpperCase()}</h1>
                <div class="live-badge"><i class="fa-solid fa-circle"></i> LIVE</div> 
            </div>
            <div id="player-container">
                <video id="${PLAYER_ID}" playsinline controls></video>
                <div class="view-counter">
                    <div class="name" id="viewChannelName">FANCODE</div>
                    <div class="views" id="viewCount">0 Views</div>
                </div>
                <div class="rotate-fallback-notice" id="rotateNotice">Rotation fallback active (iOS)   tap exit to return</div>
            </div>
            <div class="info-card">
                <h2><i class="fa-brands fa-whatsapp"></i> Follow us for Updates   !!</h2>
                    <a href="https://whatsapp.com/channel/0029VaeylYYBPzjVNomWuZ0T" target="_blank" rel="noopener" class="action-button">
                    <i class="fa-brands fa-whatsapp"></i>
                    Click Here To Join WhatsApp 
                </a>
            </div>
            <div class="info-card">
                <h2><i class="fa-solid fa-link"></i> Copy Link & Share</h2>
                <button class="action-button" id="shareButton"><i class="fa-solid fa-share-nodes"></i> Click Here To Share This Page Link</button>
            </div>
            <a href="#" class="back-link"><i class="fa-solid fa-arrow-left"></i> Back to All Streams !!</a>
        `;
        
        document.getElementById('shareButton').addEventListener('click', async () => {
            try {
                const url = window.location.href;
                await navigator.clipboard.writeText(url);
                const btn = document.getElementById('shareButton');
                const original = btn.innerHTML;
                btn.innerHTML = `<i class="fa-solid fa-check"></i> Link Copied!`;
                btn.classList.add('copied');
                setTimeout(() => 
                { btn.innerHTML = original; btn.classList.remove('copied'); }, 2000);
            } catch (err) { console.error(err); }
        });
        
        startViewCounter(); // Call counter initialization
    }
    
    // --- Main Initialization ---
    async function initializePlayer() {
        const { matchId, cdnKey } = getMatchParams();
        
        if (!matchId || !cdnKey) {
             return displayError("Missing Match Parameters. Please Use A link From The Homepage.");
        }
        
        let streamUrl = null;
        
        try {
            const data = await fetchMatchData(matchId, cdnKey);
            streamUrl = data.streamUrl;
            
            // Render UI before starting player
            renderPlayerUI(data);

        } catch (error) {
            return displayError(`Failed to load match details: ${error.message}`);
        }

        const playerElement = document.getElementById(PLAYER_ID);

        // Plyr Configuration
        const playerConfig = {
            autoplay: true,
            playsinline: true,
            muted: true,
            controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'fullscreen'],
            settings: ['quality', 'speed', 'captions'],
            speed: {
                selected: 1,
                options: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2]
            },
        };
        
        // HLS Implementation
        if (streamUrl.toLowerCase().includes('.m3u8') && Hls.isSupported()) {
            
            hlsInstance = new Hls({
                crossOrigin: 'anonymous',
                withCredentials: false,
                recoverMediaError: true,
            });

            hlsInstance.loadSource(streamUrl);
            hlsInstance.attachMedia(playerElement);
            
            hlsInstance.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                
                const qualities = data.levels.map(l => l.height).filter(Boolean);
                let availableQualities = [AUTO_QUALITY, ...new Set(qualities)].sort((a, b) => b - a);
                const defaultQuality = availableQualities.find(q => q === 720) || AUTO_QUALITY; 
                
                playerConfig.quality = {
                    default: defaultQuality,
                    options: availableQualities,
                    forced: true,
                    onChange: (newQuality) => {
                        loadingOverlay.classList.remove('hidden');
                        if (newQuality === AUTO_QUALITY) {
                            hlsInstance.currentLevel = -1;
                        } else {
                            const levelIndex = hlsInstance.levels.findIndex(level => level.height === newQuality);
                            if (levelIndex !== -1) {
                                hlsInstance.currentLevel = levelIndex;
                            }
                        }
                    },
                };

                if (plyrInstance) plyrInstance.destroy();
                plyrInstance = new Plyr(playerElement, playerConfig);
                attachPlyrEvents();
                hlsInstance.on(Hls.Events.LEVEL_SWITCHED, () => loadingOverlay.classList.add('hidden'));
                
                playerElement.play().catch(e => console.warn("Autoplay blocked/failed. User interaction required.", e));
            });
            
            hlsInstance.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                    if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                        hlsInstance.recoverMediaError();
                    } else {
                        if (hlsInstance) hlsInstance.destroy();
                        displayError(`Playback failed: ${data.reason}. Try refreshing.`);
                    }
                }
            });

        } else {
            // Direct MP4 or other non-HLS formats
            playerElement.src = streamUrl;
            if (plyrInstance) plyrInstance.destroy();
            plyrInstance = new Plyr(playerElement, playerConfig);
            attachPlyrEvents();
            
            playerElement.addEventListener('error', (e) => {
                 displayError("The video link failed to load or the format is unsupported.");
            });
            
            plyrInstance.play().catch(e => console.warn("Autoplay blocked/failed.", e));
            loadingOverlay.classList.add('hidden');
        }
    }

    // --- Popup & Startup Logic ---
    function closePopupAndInitializePlayer() {
        hidePopup();
        
        if (!playerInitialized) {
            loadingOverlay.classList.remove('hidden');
            document.querySelector('.container').style.opacity = '1';
            initializePlayer();
            playerInitialized = true;
        }
    }

    joinLink.addEventListener('click', () => { 
        setTimeout(closePopupAndInitializePlayer, 500); 
    });
    alreadyJoinedBtn.addEventListener('click', closePopupAndInitializePlayer);

    document.addEventListener('DOMContentLoaded', () => {
        // Show popup first
        showPopup();
        loadingOverlay.classList.add('hidden');
        document.querySelector('.container').style.opacity = '0'; // Hide container until initialization starts
    });

</script>
</body>
</html>
