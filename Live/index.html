<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Professional DPlayer Stream</title>
    
    <meta name="referrer" content="no-referrer" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">

    <style>
        /* --- GLOBAL STYLES --- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        }

        /* Container to center the player */
        #dplayer-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* --- DPLAYER CUSTOMIZATION --- */
        
        /* 1. Theme Color Update (#0078e8) */
        .dplayer-theme-primary {
            color: #0078e8 !important;
        }
        .dplayer-controller .dplayer-icons .dplayer-setting .dplayer-setting-box .dplayer-setting-origin-panel .dplayer-setting-item.dplayer-setting-quality .dplayer-setting-value {
            color: #0078e8 !important;
        }

        /* 2. REMOVE SPEED CONTROL (As requested) */
        .dplayer-setting-speed, 
        .dplayer-setting-loop { 
            display: none !important; 
        }

        /* 3. Force Quality Menu to be visible/styled nicely */
        .dplayer-setting-box {
            background: rgba(20, 20, 20, 0.9) !important;
        }

        /* --- POPUP STYLES (Retained from previous code) --- */
        :root {
            --popup-bg: #000000;
            --primary-color: #e30000;
            --text-light: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #2d2d2d;
        }

        .popup-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 1);
            z-index: 11000;
            display: block;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        .popup-backdrop.hidden { opacity: 0; pointer-events: none; display: none; }

        .telegram-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            background: var(--popup-bg);
            color: var(--text-light);
            padding: 40px 25px;
            border-radius: 16px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 50px 10px rgba(227, 0, 0, 0.5);
            z-index: 12000;
            text-align: center;
            width: 90%;
            max-width: 400px;
            display: block;
            opacity: 1;
            transition: all 0.5s cubic-bezier(.2,.9,.2,1);
        }
        .telegram-popup.hidden { display: none; opacity: 0; }
        
        .telegram-popup h2 { margin-top: 0; color: var(--primary-color); font-size: 1.75rem; margin-bottom: 0.75rem; }
        .telegram-popup p { font-size: 1rem; color: var(--text-muted); margin-bottom: 1.75rem; }
        
        .telegram-popup button {
            width: 100%; padding: 14px; margin-top: 12px; font-size: 1rem;
            border: none; border-radius: 10px; cursor: pointer; font-weight: 600;
            transition: transform 0.2s ease;
        }
        .telegram-popup button:hover { transform: translateY(-2px); }
        
        .telegram-popup .join-btn { background: #e30000; color: white; }
        .telegram-popup .joined-btn { background: #2d2d2d; color: #f1f5f9; border: 1px solid #b30000; }

        /* Error Overlay Style */
        .info-overlay {
            color: #fff; text-align: center; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); padding: 20px 30px;
            background: rgba(0,0,0,0.8); border: 1px solid #0078e8; border-radius: 8px; z-index: 999;
        }
    </style>
</head>
<body>

    <div class="popup-backdrop" id="popupBackdrop"></div>
    <div class="telegram-popup" id="telegramPopup">
        <h2><i class="fa-brands fa-whatsapp"></i> Support Us!</h2>
        <p>Join our Whatsapp channel <strong>ùóñùó•ùóúùóñùóûùóòùóß ùó°ùóòùó™ùó¶ ùó£ùó¢ùóúùó°ùóß</strong> For Instant Updates And Exclusive Links.</p>
        <a href="https://whatsapp.com/channel/0029VaeylYYBPzjVNomWuZ0T" target="_blank" rel="noopener" id="joinLink" style="text-decoration: none;">
            <button class="join-btn">Join Now</button>
        </a>
        <button class="joined-btn" id="alreadyJoinedBtn">Already Joined</button>
    </div>

    <div id="dplayer-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>

    <script>
        // --- CONSTANTS ---
        const URL_PARAM_KEY = 'ios';
        const DEFAULT_QUALITY_HEIGHT = 480;
        const THEME_COLOR = '#0078e8'; // New Blue Color

        // --- POPUP LOGIC ---
        const popupBackdrop = document.getElementById('popupBackdrop');
        const telegramPopup = document.getElementById('telegramPopup');
        const joinLink = document.getElementById('joinLink');
        const alreadyJoinedBtn = document.getElementById('alreadyJoinedBtn');
        let playerInitialized = false;

        function closePopupAndPlay() {
            popupBackdrop.classList.add('hidden');
            telegramPopup.classList.add('hidden');
            if (!playerInitialized) {
                // Start the logic to verify link and load player
                prepareAndInitPlayer(); 
                playerInitialized = true;
            }
        }

        joinLink.addEventListener('click', () => { setTimeout(closePopupAndPlay, 500); });
        alreadyJoinedBtn.addEventListener('click', closePopupAndPlay);

        // --- UTILITY ---
        function getVideoUrlFromQuery() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get(URL_PARAM_KEY);
            return videoUrl ? decodeURIComponent(videoUrl) : null;
        }

        function displayOverlay(title, message) {
            const container = document.getElementById('dplayer-container');
            if (document.querySelector('.info-overlay')) return; 
            container.innerHTML = `<div class="info-overlay"><h2>${title}</h2><p style="margin-top:10px; opacity:0.8;">${message}</p></div>`;
        }

        // --- DPLAYER + HLS PRE-LOADER LOGIC ---
        // This function parses the HLS levels BEFORE initializing DPlayer
        // This is the only way to ensure Quality Buttons appear correctly in DPlayer for HLS
        
        function prepareAndInitPlayer() {
            const videoUrl = getVideoUrlFromQuery();

            if (!videoUrl) {
                displayOverlay("Error", "Missing video URL. Use format: <code>?ios=LINK</code>");
                return;
            }

            // Step 1: Pre-load HLS to get levels (if .m3u8)
            if (Hls.isSupported() && videoUrl.toLowerCase().endsWith('.m3u8')) {
                const tempHls = new Hls();
                tempHls.loadSource(videoUrl);
                
                tempHls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                    // Extract levels
                    const levels = data.levels;
                    
                    // Build Quality Array for DPlayer
                    // Note: DPlayer expects 'type: hls' usually, but to use custom switching we use 'customHls'
                    // We map all levels to the SAME url, but we will handle switching internally
                    
                    let qualityList = levels.map((level, index) => ({
                        name: level.height + 'p',
                        url: videoUrl,
                        type: 'customHls', // Custom type handler
                        index: index // Store index for switching
                    }));

                    // Add 'Auto' option at the top
                    qualityList.unshift({
                        name: 'Auto',
                        url: videoUrl,
                        type: 'customHls',
                        index: -1
                    });

                    // Determine Default Quality Index (480p)
                    let defaultQualityIndex = 0; // Default to Auto
                    const p480Index = qualityList.findIndex(q => q.name === '480p');
                    if (p480Index !== -1) {
                        defaultQualityIndex = p480Index;
                    }

                    // Destroy temp instance and Init Real Player
                    tempHls.destroy();
                    initDPlayer(videoUrl, qualityList, defaultQualityIndex);
                });

                tempHls.on(Hls.Events.ERROR, function (event, data) {
                    if(data.fatal) {
                        tempHls.destroy();
                        displayOverlay("Stream Error", "Could not load HLS stream info.");
                    }
                });
            } else {
                // Standard MP4 or No HLS support
                initDPlayer(videoUrl, null, 0);
            }
        }

        // --- DPLAYER INITIALIZATION ---
        function initDPlayer(url, qualityList, defaultQualityIndex) {
            
            // Shared HLS instance for the player
            let hlsInstance = null;

            const dp = new DPlayer({
                container: document.getElementById('dplayer-container'),
                autoplay: true,
                theme: THEME_COLOR, // #0078e8
                loop: false,
                lang: 'en',
                hotkey: true,
                preload: 'auto',
                volume: 0.7,
                mutex: true,
                // If quality list exists, use it. Otherwise just use simple url
                video: qualityList ? {
                    quality: qualityList,
                    defaultQuality: defaultQualityIndex,
                    type: 'customHls', // Trigger custom handler
                    customType: {
                        customHls: function (video, player) {
                            // If HLS already exists (quality switch), just switch level
                            if (hlsInstance) {
                                // Find the index from the qualityList based on the *name* (DPlayer limitation)
                                // But simpler: we check the currently selected quality index from DPlayer
                                const currentQualityName = player.quality.name; // e.g., '480p'
                                const selectedObj = qualityList.find(q => q.name === currentQualityName);
                                
                                if (selectedObj) {
                                    console.log("Switching to Level: " + selectedObj.index);
                                    hlsInstance.currentLevel = selectedObj.index; 
                                }
                                return;
                            }

                            // First Load initialization
                            hlsInstance = new Hls();
                            hlsInstance.loadSource(video.src);
                            hlsInstance.attachMedia(video);
                            
                            // Set initial level based on defaultQualityIndex
                            const startObj = qualityList[defaultQualityIndex];
                            if(startObj && startObj.index !== -1) {
                                hlsInstance.startLevel = startObj.index;
                            } else {
                                hlsInstance.startLevel = -1; // Auto
                            }
                        }
                    }
                } : {
                    url: url,
                    type: 'auto'
                }
            });

            // --- FULLSCREEN LANDSCAPE LOCK ---
            dp.on('fullscreen', () => {
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(() => {});
                }
            });
            dp.on('fullscreen_cancel', () => {
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            });

            // Ensure Speed Menu is hidden (CSS handles it, but just in case)
            // DPlayer creates menu items dynamically. CSS is the best way to hide them.
        }
    </script>
</body>
</html>
