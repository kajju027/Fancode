<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Video Player with WebSocket Danmaku</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer@latest/dist/DPlayer.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            flex-direction: column;
        }
        #dplayer {
            width: 80%;
            max-width: 900px;
            height: 500px;
            margin-bottom: 20px;
        }
        .info-box {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 80%;
            max-width: 900px;
        }
    </style>
</head>
<body>

    <div id="dplayer"></div>

    <div class="info-box">
        <h3>Danmaku Simulation</h3>
        <p>ভিডিও প্লেয়ারের ডানদিকে থাকা টগল বোতামে ক্লিক করলে প্লেয়ারে একটি নকল WebSocket Danmaku দেখাবে।</p>
        <button id="send-danmaku-btn">Send Simulated Danmaku</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script> <script src="https://cdn.jsdelivr.net/npm/dplayer@latest/dist/DPlayer.min.js"></script>
    <script>
        const videoURL = 'https://bitdash-a.akamaihd.net/content/sintel/hls/playlist.m3u8'; // Sintel Demo HLS Link
        
        // --- 1. DPlayer Initialization ---
        const dp = new DPlayer({
            container: document.getElementById('dplayer'),
            live: true,          // Enable Live Mode (shows 'LIVE' indicator)
            danmaku: true,       // Enable Danmaku
            apiBackend: {
                // This function is usually called by DPlayer to fetch historical danmaku from the server.
                read: function (options) {
                    console.log('API Backend: Pretend to connect and fetch historical Danmaku via WebSocket or API...');
                    // options.success() must be called with an array of danmaku objects.
                    // For live streams, you usually return an empty array or the last few messages.
                    options.success([]); 
                },
                // This function is called when a user sends a new danmaku from the player input box.
                send: function (options) {
                    console.log('API Backend: Pretend to send Danmaku via WebSocket/API:', options.data);
                    // After successfully sending, call options.success()
                    options.success(); 
                },
            },
            video: {
                url: videoURL,
                type: 'hls',     // Must specify 'hls' for M3U8 links
                // poster: 'image_url.jpg', // Optional: Poster image for before playback
            },
        });

        // --- 2. Live Danmaku Drawing Logic (Simulation) ---
        
        // Define the danmaku object structure
        const danmakuData = {
            text: 'WebSocket Danmaku: লাইভ কমেন্ট দেখানো হচ্ছে!',
            color: '#FF0000', // Red color
            type: 'right',    // Scrolls from right to left (Type 0/right, 1/top, 2/bottom)
            // time: dp.video.currentTime, // For real-time, time is optional but good practice
        };

        // Function to draw the danmaku on the player
        function drawSimulatedDanmaku() {
            // Get the current time of the video to ensure the danmaku is displayed instantly
            danmakuData.time = dp.video.currentTime + 0.1; 
            
            // Use the DPlayer API to draw the danmaku directly
            dp.danmaku.draw(danmakuData);

            console.log('Danmaku drawn successfully:', danmakuData.text);
        }

        // Attach the drawing function to the button click for demonstration
        document.getElementById('send-danmaku-btn').addEventListener('click', drawSimulatedDanmaku);


        // --- REAL-WORLD SCENARIO ---
        // In a real application, you would connect to a WebSocket server:
        /*
        const ws = new WebSocket('ws://your-danmaku-server.com/ws');
        ws.onmessage = function(event) {
            try {
                const receivedDanmaku = JSON.parse(event.data);
                // The received data must match the danmaku object structure
                receivedDanmaku.time = dp.video.currentTime + 0.1; // Ensure it shows now
                dp.danmaku.draw(receivedDanmaku);
            } catch (e) {
                console.error('Failed to parse Danmaku data:', e);
            }
        };
        */
    </script>

</body>
</html>
