<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAMCODE OFFICIAL VIDEO PLAYER</title></title>
    
    <meta name="referrer" content="no-referrer" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* --- GLOBAL & BASE STYLES --- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        }

        #player-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* --- JW PLAYER CUSTOMIZATION (Theme: #0078e8) --- */
        
        /* Set primary accent color for controls */
        .jw-button-color,
        .jw-controlbar .jw-icon-active,
        .jw-slider-time .jw-knob {
            color: #0078e8 !important;
        }
        
        /* Set color for time slider and volume */
        .jw-rail-active {
            background-color: #0078e8 !important;
        }

        /* Hide speed menu item (JW Player doesn't have an easy way, but we hide relevant CSS selectors if present) */
        .jw-settings-content .jw-settings-item-playbackRate {
            display: none !important;
        }
        
        /* --- CUSTOM LOADING OVERLAY --- */
        #loading-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 600;
            z-index: 10000; /* Above JW Player */
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        #loading-message.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #0078e8; /* Theme color spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- POPUP STYLES (Retained) --- */
        :root {
            --popup-bg: #000000;
            --primary-color: #e30000;
            --text-light: #f1f5f9;
        }
        .popup-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 1); z-index: 11000;
        }
        .popup-backdrop.hidden { opacity: 0; pointer-events: none; display: none; }
        .telegram-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--popup-bg); color: var(--text-light); padding: 40px 25px;
            border-radius: 16px; border: 2px solid var(--primary-color);
            box-shadow: 0 0 50px 10px rgba(227, 0, 0, 0.5); z-index: 12000;
            text-align: center; width: 90%; max-width: 400px;
        }
        .telegram-popup.hidden { display: none; opacity: 0; }
        .telegram-popup h2 { margin-top: 0; color: var(--primary-color); font-size: 1.75rem; }
        .telegram-popup button {
            width: 100%; padding: 14px; margin-top: 12px; font-size: 1rem;
            border: none; border-radius: 10px; cursor: pointer; font-weight: 600;
        }
        .telegram-popup .join-btn { background: #e30000; color: white; }
        .telegram-popup .joined-btn { background: #2d2d2d; color: #f1f5f9; border: 1px solid #b30000; }

        /* Error Overlay Style */
        .info-overlay {
            color: #fff; text-align: center; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); padding: 20px 30px;
            background: rgba(0,0,0,0.8); border: 1px solid #0078e8; border-radius: 8px; z-index: 9999;
        }
        
        /* Custom quality selector styles for HLS integration */
        .quality-selector {
            position: absolute;
            bottom: 60px; /* Adjust based on control bar height */
            right: 150px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            padding: 5px 0;
            z-index: 999;
            display: none;
        }
        .quality-selector.active {
            display: block;
        }
        .quality-selector button {
            background: none;
            border: none;
            color: #fff;
            padding: 8px 15px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
        }
        .quality-selector button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .quality-selector button.active {
            color: #0078e8; /* Theme color */
            font-weight: bold;
        }
    </style>
</head>
<body>

    <script src="https://cdn.jwplayer.com/libraries/YOUR_JWPLAYER_LICENSE_KEY.js"></script>
    <div class="popup-backdrop" id="popupBackdrop"></div>
    <div class="telegram-popup" id="telegramPopup">
        <h2><i class="fa-brands fa-whatsapp"></i> Support Us!</h2>
        <p>Join our Whatsapp channel <strong>ùóñùó•ùóúùóñùóûùóòùóß ùó°ùóòùó™ùó¶ ùó£ùó¢ùóúùó°ùóß</strong> For Instant Updates And Exclusive Links.</p>
        <a href="https://whatsapp.com/channel/0029VaeylYYBPzjVNomWuZ0T" target="_blank" rel="noopener" id="joinLink" style="text-decoration: none;">
            <button class="join-btn">Join Now</button>
        </a>
        <button class="joined-btn" id="alreadyJoinedBtn">Already Joined</button>
    </div>

    <div id="player-container">
        <div id="jwplayer-instance"></div>
        
        <div id="loading-message">
            <div class="loading-spinner"></div>
            <span>Loading stream... Please wait.</span>
        </div>
        
        <div id="quality-selector" class="quality-selector"></div>
    </div>

    <script>
        // --- CONSTANTS ---
        const URL_PARAM_KEY = 'ios';
        const DEFAULT_QUALITY_HEIGHT = 360; // 360p as requested
        const CONTAINER_ID = 'jwplayer-instance';

        // --- DOM ELEMENTS ---
        const popupBackdrop = document.getElementById('popupBackdrop');
        const telegramPopup = document.getElementById('telegramPopup');
        const joinLink = document.getElementById('joinLink');
        const alreadyJoinedBtn = document.getElementById('alreadyJoinedBtn');
        const loadingMessage = document.getElementById('loading-message');
        const qualitySelector = document.getElementById('quality-selector');
        
        let playerInitialized = false;
        let hlsInstance = null;
        let jwPlayerInstance = null;
        let availableQualities = []; // Store HLS levels

        // --- POPUP & LOADER CONTROL ---

        function hideLoadingMessage() {
             loadingMessage.classList.add('hidden');
        }

        function closePopupAndPlay() {
            popupBackdrop.classList.add('hidden');
            telegramPopup.classList.add('hidden');
            
            loadingMessage.classList.remove('hidden'); 

            if (!playerInitialized) {
                prepareAndInitPlayer(); 
                playerInitialized = true;
            }
        }

        joinLink.addEventListener('click', () => { setTimeout(closePopupAndPlay, 500); });
        alreadyJoinedBtn.addEventListener('click', closePopupAndPlay);

        // --- UTILITY & ERROR ---
        function getVideoUrlFromQuery() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get(URL_PARAM_KEY);
            return videoUrl ? decodeURIComponent(videoUrl) : null;
        }

        function displayOverlay(title, message) {
            const container = document.getElementById('player-container');
            hideLoadingMessage(); 
            if (document.querySelector('.info-overlay')) return; 
            container.innerHTML += `<div class="info-overlay"><h2>${title}</h2><p style="margin-top:10px; opacity:0.8;">${message}</p></div>`;
        }

        // --- HLS.js PRE-LOADER & QUALITY SETUP ---
        
        function prepareAndInitPlayer() {
            const videoUrl = getVideoUrlFromQuery();

            if (!videoUrl) {
                displayOverlay("Error", "Missing video URL. Use format: <code>?ios=LINK</code>");
                return;
            }

            if (Hls.isSupported() && videoUrl.toLowerCase().endsWith('.m3u8')) {
                const tempHls = new Hls();
                tempHls.loadSource(videoUrl);
                
                tempHls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                    tempHls.destroy();
                    
                    // Filter unique heights
                    availableQualities = data.levels
                        .map((level, index) => ({
                            height: level.height,
                            index: index
                        }))
                        .filter((v, i, a) => a.findIndex(t => t.height === v.height) === i)
                        .sort((a, b) => a.height - b.height);

                    // Add Auto
                    availableQualities.unshift({ height: 0, index: -1 });

                    // Determine Default Quality Index
                    let defaultLevelIndex = -1; // -1 means Auto
                    const defaultQuality = availableQualities.find(q => q.height === DEFAULT_QUALITY_HEIGHT);
                    if (defaultQuality) {
                        defaultLevelIndex = defaultQuality.index;
                    }
                    
                    // Initialize the actual player
                    initJWPlayer(videoUrl, defaultLevelIndex);
                });

                tempHls.on(Hls.Events.ERROR, function (event, data) {
                    if(data.fatal) {
                        tempHls.destroy();
                        displayOverlay("Stream Error", "Could not load HLS stream info.");
                    }
                });
            } else {
                // Non-HLS Fallback (No custom quality switching here)
                initJWPlayer(videoUrl, -1);
                hideLoadingMessage(); // Hide loading immediately for direct links
            }
        }

        // --- HLS QUALITY SWITCHING FUNCTIONS ---
        
        function buildQualityMenu() {
            qualitySelector.innerHTML = '';
            availableQualities.forEach(q => {
                const btn = document.createElement('button');
                btn.textContent = q.height === 0 ? 'Auto' : `${q.height}p`;
                btn.dataset.levelIndex = q.index;
                btn.addEventListener('click', () => switchHlsQuality(q.index, btn.textContent));
                qualitySelector.appendChild(btn);
            });
            updateQualityMenuDisplay(hlsInstance ? hlsInstance.currentLevel : -1);
        }

        function updateQualityMenuDisplay(activeLevelIndex) {
            Array.from(qualitySelector.children).forEach(btn => {
                const index = parseInt(btn.dataset.levelIndex);
                // Highlight the active button
                btn.classList.toggle('active', index === activeLevelIndex || (index === -1 && activeLevelIndex === -1));
            });
        }

        function switchHlsQuality(levelIndex, label) {
            if (hlsInstance) {
                hlsInstance.currentLevel = levelIndex;
                qualitySelector.classList.remove('active');
                // You might want to update a UI element here to show the current quality
                jwPlayerInstance.setCaptions({
                    'enabled': true,
                    'labels': ['Quality: ' + label],
                    'defaultId': 0
                });
            }
        }

        // --- JW PLAYER INITIALIZATION ---
        function initJWPlayer(url, defaultLevelIndex) {
            const videoElement = document.getElementById(CONTAINER_ID);
            const videoTag = document.createElement('video');
            videoTag.id = 'hls-video-tag'; // Use a standard video tag for hls.js
            videoTag.className = 'jw-video-placeholder';
            videoElement.appendChild(videoTag);
            
            // 1. Initialize HLS.js
            hlsInstance = new Hls();
            hlsInstance.loadSource(url);
            hlsInstance.attachMedia(videoTag);
            
            hlsInstance.on(Hls.Events.MEDIA_ATTACHED, function () {
                // Set the default quality level
                hlsInstance.startLevel = defaultLevelIndex; 
            });

            // 2. Initialize JW Player (using the video tag as the source)
            jwPlayerInstance = jwplayer(CONTAINER_ID).setup({
                // Note: The free JW Player does not support advanced live configuration easily.
                // We use a basic setup relying on hls.js.
                file: url, // Provide URL for JW's internal config (optional, but good)
                type: 'hls', // Tells JW that this is HLS
                width: '100%',
                height: '100%',
                autostart: true,
                stretching: 'uniform',
                controls: true,
                repeat: false,
                displaytitle: false,
                // We must use a source that JW can handle, but the actual playback will be the HTML5 video tag.
                // Since we attached HLS.js to a specific video tag, we can try to use a dummy config for JW
                // and rely on events.
                primary: 'html5',
                live: true, // Show live indicator
            });
            
            // 3. Custom HLS and Player Interaction
            hlsInstance.on(Hls.Events.MANIFEST_PARSED, buildQualityMenu);

            jwPlayerInstance.on('ready', function() {
                // Force play if needed
                jwPlayerInstance.play();

                // Create a Quality Button in the JW Control Bar
                this.addButton(
                    'https://cdn.jwplayer.com/players/assets/settings-icon.svg', 
                    'Quality', 
                    function() {
                        qualitySelector.classList.toggle('active');
                    },
                    'quality-button'
                );
                
                // Hide loading message when JW Player starts playing
                this.on('play', hideLoadingMessage);
                
                // Fullscreen Lock for Mobile
                this.on('fullscreen', function(event) {
                    if (event.fullscreen && screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('landscape').catch(() => {});
                    } else if (!event.fullscreen && screen.orientation && screen.orientation.unlock) {
                        screen.orientation.unlock();
                    }
                });
            });

            jwPlayerInstance.on('error', function() {
                 displayOverlay("Playback Failed", "The stream could not be loaded by the player.");
            });
        }
    </script>
</body>
</html>
